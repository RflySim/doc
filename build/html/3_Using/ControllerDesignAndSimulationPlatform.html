

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2. Simulink-Based Controller Design and Simulation Platform &mdash; RflySimDoc 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. PSP Toolbox" href="PSPToolbox.html" />
    <link rel="prev" title="1. Brief Introduction to Experimental Platforms" href="Introduction.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> RflySimDoc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../0_Start/WhatIsRflysim.html">1. What is RflySim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_Start/GettingStarted.html">2. Getting Started</a></li>
</ul>
<p class="caption"><span class="caption-text">Modeling</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../1_Modeling/Modeling.html">1. Modeling</a></li>
</ul>
<p class="caption"><span class="caption-text">Experimental Process</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../2_Configuration/Introduction.html">1. Overall Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Configuration/SoftwareInstallation.html">2. Software Package Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_Configuration/HardwareConfiguration.html">3. Hardware Platform Configuration</a></li>
</ul>
<p class="caption"><span class="caption-text">Experimental Platform Usage:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">1. Brief Introduction to Experimental Platforms</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. Simulink-Based Controller Design and Simulation Platform</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#controller">2.1. Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multicopter-model">2.2. Multicopter Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#flightgear-interface">2.3. FlightGear Interface</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="PSPToolbox.html">3. PSP Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="PixhawkHardwareSystem.html">4. Pixhawk Hardware System</a></li>
<li class="toctree-l1"><a class="reference internal" href="HILSimulator.html">5. HIL Simulation Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="Examples.html">6. Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">RflySim Advanced Functions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../4_Pro/Advanced.html">1. Installation Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_Pro/BasicFeatures.html">2. Basic Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_Pro/OtherTypesofVehicles.html">3. Other Types of Vehicles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_Pro/Customizationof3DScenarios.html">4. Customization of 3D Scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_Pro/UAVSwarmControl.html">5. UAV Swarm Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_Pro/UAVVisionAIControl.html">6. UAV Vision/AI Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_Pro/FuturePlan.html">7. Future Plan</a></li>
</ul>
<p class="caption"><span class="caption-text">Course</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../5_Course/Book.html">1. Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5_Course/CourseContent.html">2. Course Content</a></li>
</ul>
<p class="caption"><span class="caption-text">Download &amp; Support:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../7_DownloadAndSupport/DownloadAndSupport.html">1. Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_DownloadAndSupport/DownloadAndSupport.html#faq">2. FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_DownloadAndSupport/DownloadAndSupport.html#support">3. Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_DownloadAndSupport/DownloadAndSupport.html#reference">4. Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">RflySimDoc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>2. Simulink-Based Controller Design and Simulation Platform</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/3_Using/ControllerDesignAndSimulationPlatform.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="simulink-based-controller-design-and-simulation-platform">
<h1>2. Simulink-Based Controller Design and Simulation Platform<a class="headerlink" href="#simulink-based-controller-design-and-simulation-platform" title="Permalink to this headline">¶</a></h1>
<p>To improve the design efficiency of multicopter controllers, as shown in Fig. 3.5, this
book provides a high-fidelity simulation environment based on Simulink/FlightGear.
The main source code file is presented in “e01.SoftwareSimExps
CopterSim3DEnvironment.slx”.</p>
<blockquote>
<div><div class="figure align-center" id="id3">
<img alt="../_images/Quan-ch3-Fig3.5.jpg" src="../_images/Quan-ch3-Fig3.5.jpg" />
<p class="caption"><span class="caption-text">Fig. 3.5 Files in “SoftwareSimExps” folder</span></p>
</div>
</div></blockquote>
<p>The following steps describe the correct way to open Simulink files (those with
the file suffix “.slx”).</p>
<p>(1). Open MATLAB via the Windows desktop shortcut or the Windows start menu.
(2). As shown in Fig. 3.6, click the “Browse Folder” button in the MATLAB User
Interface (UI) to set the current directory to the folder of the “.slx” file to be
opened.</p>
<blockquote>
<div><div class="figure align-center" id="id4">
<img alt="../_images/Quan-ch3-Fig3.6.jpg" src="../_images/Quan-ch3-Fig3.6.jpg" />
<p class="caption"><span class="caption-text">Fig. 3.6 Method to correctly open a Simulink slx file</span></p>
</div>
</div></blockquote>
<p>(3). Double-click the “.slx” file in the “Current Folder” window (the lower-left side
in Fig. 3.6) to open it.</p>
<p>All “.slx” files should be opened in this way to ensure that the working directory is
correct and that the initialization scripts are successfully loaded.</p>
<blockquote>
<div><div class="figure align-center" id="id5">
<img alt="../_images/Quan-ch3-Fig3.7.jpg" src="../_images/Quan-ch3-Fig3.7.jpg" />
<p class="caption"><span class="caption-text">Fig. 3.7 Simulink SIL simulation example</span></p>
</div>
</div></blockquote>
<p>Open the “CopterSim3DEnvironment.slx” file according to the above procedure;
then, a SIL simulation example will appear as shown in Fig. 3.7. The SIL simulation
example contains three subsystems: the “Controller” subsystem, the “Multicopter
Model” subsystem, and the “FlightGear Interface” subsystem. Their key features are
summarized below.</p>
<p>(1). The input, output, and feedback signals of the “Controller” subsystem are
consistent with the available signals in a real autopilot system. For example, the
input signals of the controller in Fig. 3.7 are the control commands for pitch,
roll, yaw, and altitude control from a simulated RC transmitter, and the output
signals are the motor PWM signals for a multicopter model.</p>
<p>(2). The controller uses the sensor estimated states (e.g., attitude, angular velocity,
position, velocity, and other state information) to achieve stable attitude control.</p>
<p>(3). The input and output signals of the “MulticopterModel” subsystem are consistent
with those of a real multicopter. For example, the input signals of the “Multicopter
Model” subsystem are the PWM control signals of eight motors (the multicopter
model will choose the actual number of motors according to the selected model)
defined by the Pixhawk autopilot (the data range is 1000–2000 corresponding
to a throttle command of 0–1), and the output signals are the data from various
sensors.</p>
<p>(4). “FlightGear Interface” subsystem provides a communication interface to send the
flight data to FlightGear, where the real-time vehicle attitude and flight trajectory
can be observed in a realistic 3D scene.</p>
<div class="section" id="controller">
<h2>2.1. Controller<a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h2>
<p>Double-click the “Controller” subsystem in Fig. 3.7 yields the internal structure of the
controller, as presented in Fig. 3.8. This example shows a simple attitude controller
for pitch and roll angles. The controller receives the control signals from the RC
transmitter and controls the multicopter to achieve the desired pitch and roll angles.</p>
<p>As shown in Fig. 3.8, the 1st–5th input ports are five input channels from the RC
transmitter (“ch1”–“ch5”); the 6th–8th input ports are the angular velocity (“p”, “q”,
“r”) from the gyroscope sensor; the 9th–10th input ports are the roll angle and pitch
angles (“phi”, “theta”) estimated from the inertial sensor. As shown in Fig. 3.8, the
computing process of the entire “Controller” subsystem is roughly divided into five
steps.</p>
<blockquote>
<div><div class="figure align-center" id="id6">
<img alt="../_images/Quan-ch3-Fig3.8.jpg" src="../_images/Quan-ch3-Fig3.8.jpg" />
<p class="caption"><span class="caption-text">Fig. 3.8 Internal structure of “Controller” subsystem</span></p>
</div>
</div></blockquote>
<p>(1). The “Input Interfaces” module receives the RC transmitter signals and the
multicopter state estimation signals. <a class="footnote-reference" href="#f1" id="id1">[1]</a></p>
<p>(2). The “RC Signal Process” module maps the five-channel signals of the RC
transmitter to the desired roll and pitch angle values.</p>
<p>(3). The “Attitude Controller” module computes the desired force and torque values
to control the multicopter to the desired attitude.</p>
<p>(4). The “Motor Control Signal Computation” module maps the force and torque
values to the control signals (ranging from 1000 to 2000) for the four motors.</p>
<p>(5). The “Output Interfaces” module fills the remaining 4-dimensional control signals
and generates an 8-dimensional PWM signal (there are eight PWM output ports
on Pixhawk) ranging from 1000 to 2000µs. <a class="footnote-reference" href="#f2" id="id2">[2]</a></p>
</div>
<div class="section" id="multicopter-model">
<h2>2.2. Multicopter Model<a class="headerlink" href="#multicopter-model" title="Permalink to this headline">¶</a></h2>
<p>Double-click the “Multicopter Model” subsystem in Fig. 3.7, and the internal
structure of the multicopter model is presented in Fig. 3.9. The multicopter model
simulates a real multicopter system to output the flight state and sensor signals
based on the motor PWM controls from the control system.</p>
<blockquote>
<div><div class="figure align-center" id="id7">
<img alt="../_images/Quan-ch3-Fig3.9.jpg" src="../_images/Quan-ch3-Fig3.9.jpg" />
<p class="caption"><span class="caption-text">Fig. 3.9 Internal structure of “Multicopter Model” subsystem</span></p>
</div>
</div></blockquote>
<p>As shown in Fig. 3.9, the “Multicopter Model” subsystem contains the following
seven main modules.</p>
<p>(1). “Motor Model” module: it simulates the motor dynamics.</p>
<p>(2). “Force and Moment Model” module: it simulates all external forces and moments
acting on the body, such as the propeller thrust, fuselage aerodynamics, gravity,
and ground supporting force.</p>
<p>(3). “Rigid Body Kinematics Model” module: it calculates the vehicle kinematics of
the multicopter, such as speed, position, and attitude.</p>
<p>(4). “Environmental Model” module: it calculates the environmental data, such as
gravitational acceleration, air density, wind disturbances, and geomagnetic field.</p>
<p>(5). “Fault Model” module: it is mainly used to inject model uncertainties (related
to mass and moment of inertia) as well as faults.</p>
<p>(6). “Battery Model” module: it simulates the discharge process of the battery.</p>
<p>(7). “Output Interface Model” module: it packs the output signals in the desired
format.</p>
<p>The controller parameters are stored in an initialization script “e01.Software
SimExpsInit_control.m”. This script will be automatically called to import all
parameters into the Simulink workspace when the simulation starts. Figure 3.10
depicts how to proceed to autorun the initialization script. Readers can open the
UI in Fig. 3.10 by clicking “File”—“Model Properties”—“Callbacks”—“InitFcn” in
the Simulink menu within the “CopterSim3DEnvironment.slx” project. The source
code of the “Init_control.m” initialization script is listed in Table 3.1.</p>
<blockquote>
<div><div class="figure align-center" id="id8">
<img alt="../_images/Quan-ch3-Fig3.10.jpg" src="../_images/Quan-ch3-Fig3.10.jpg" />
<p class="caption"><span class="caption-text">Fig. 3.10 Initialization interface for the “Init_control.m” script</span></p>
</div>
</div></blockquote>
<p>All the parameters required by the “Multicopter Model” are stored in the script
“e01.SoftwareSimExpsiconInit.m”. This script will be automatically called when
the second line (see Table 3.1) of the “Init_control.m” script is executed. The key
model parameters are listed in Tables 3.2, 3.3, 3.4, 3.5, and 3.6. By modifying the
above model parameters, multicopters with different sizes and configurations (see
Table 3.5) can be obtained, and flight simulations under different environments (see
Table 3.6) can be performed.</p>
</div>
<div class="section" id="flightgear-interface">
<h2>2.3. FlightGear Interface<a class="headerlink" href="#flightgear-interface" title="Permalink to this headline">¶</a></h2>
<p>As shown in Fig. 3.7, the “FlightGear Interface” subsystem has three input ports
representing the multicopter position, Euler angles, and motor PWM signals,
respectively. This subsystem sends multicopter flight state information to FlightGear to
observe the flight attitude and trajectory of the multicopter in a 3D scene. The steps
to follow are described next.</p>
<p>(1). Double-click the FlightGear-F450 shortcut on the desktop to open FlightGear;</p>
<p>(2). Click the “Run” button on the Simulink toolbar (see Fig. 3.11) to run the
“CopterSim3DEnvironment.slx” file;</p>
<blockquote>
<div><div class="figure align-center" id="id9">
<img alt="../_images/Quan-ch3-Fig3.11.jpg" src="../_images/Quan-ch3-Fig3.11.jpg" />
<p class="caption"><span class="caption-text">Fig. 3.11 Simulink “Run” button for different MATLAB versions</span></p>
</div>
</div></blockquote>
<p>(3). Then, as shown in Fig. 3.12, the multicopter takes off vertically from the ground
and starts flying forward at a certain pitch angle after 5 s.</p>
<blockquote>
<div><div class="figure align-center" id="id10">
<img alt="../_images/Quan-ch3-Fig3.12.jpg" src="../_images/Quan-ch3-Fig3.12.jpg" />
<p class="caption"><span class="caption-text">Fig. 3.12 A quadcopter in FlightGear</span></p>
</div>
</div></blockquote>
<p class="rubric">Notes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>In a real autopilot system, these signals should be obtained from the modules related to state estimation (e.g., raw sensor data, Kalman filter, and complementary filter). For simplicity, in the controller design during the SIL simulation the true values of the multicopter model can be used first.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>A value within the range from 1000 to 2000 corresponds to a higher level duration (in microseconds) of PWM signals. Given that the period of an RC PWM signal is usually 20 ms (50 Hz), the duty ratio of the PWM signal measured by a multimeter usually ranges from 0.05 to 0.1 instead of from 0 to 1.</td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="PSPToolbox.html" class="btn btn-neutral float-right" title="3. PSP Toolbox" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Introduction.html" class="btn btn-neutral float-left" title="1. Brief Introduction to Experimental Platforms" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Rfly

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>